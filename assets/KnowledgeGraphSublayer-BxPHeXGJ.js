const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-6cdRR6IH.js","assets/_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{a7 as le,wt as Y,H as et,fE as P,j5 as dt,e as z,j0 as ut,dv as ct,c5 as Ne,_ as yt,jS as ht,f6 as tt,bJ as rt,di as st,dl as J,aK as mt,fW as pe,j2 as B,fX as se,a6 as de,lf as ve,ay as it,n as y,p as h,u as ye,n$ as nt,qT as ft,qU as gt,o0 as at,r5 as bt,B1 as wt,sg as Tt,r8 as K,bT as ie,B2 as ne,ak as Se,ka as It,re as Et,tq as Le,c4 as _t,dR as $t,qY as Nt,qZ as vt,q_ as St,f9 as Lt,qX as Mt,iO as kt,fa as Dt,ix as Ct,c as xt,B3 as Ft,em as oe,jj as ee,r0 as Rt,o1 as At,f2 as Me,qs as ke,r2 as Ot,dA as jt,r1 as qt,bG as Pt,c7 as Gt,k as Ut,dz as A,B4 as Ht,B5 as zt,B6 as Bt,va as Qt,B7 as Wt,B8 as Vt,iz as Jt,ro as Zt,rp as Kt,r9 as Yt,B9 as Xt,ra as er,f3 as tr,rc as rr,sP as sr,a8 as ir,x6 as nr,r7 as ar}from"./index-CFvNsE3P.js";import{i as Ie,r as or,n as Ee,a as Z,l as lr,V as pr}from"./knowledgeGraphService-B6oEKKJQ.js";import{I as ue,t as ce,_ as R,E as ae,S as _e,o as be}from"./constants-SxxbBSOD.js";import"./GraphicsLayer-CYIBqv-E.js";import{p as W,a as De,i as Ce}from"./GraphQueryStreaming-VWZ-baNO.js";import{f as dr}from"./FeatureStore-Hdea8vTp.js";import{W as ur}from"./QueryEngine-2wp0G5Mu.js";import{u as xe}from"./clientSideDefaults-BPNfypA9.js";import{s as cr,t as yr}from"./QueryEngineCapabilities-DJC_YILC.js";let hr=class{constructor(){this.version="",this.queryResult=new mr}},mr=class{constructor(){this.featureResult=new fr}},fr=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new gr,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new br,this.geometryType=null,this.spatialReference=new le,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new ot,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},gr=class{constructor(){this.name="",this.isSystemMaintained=!1}},br=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},ot=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new wr,this.translate=new Tr}},wr=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},Tr=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Ir=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},Er=class{constructor(){this.attributes=[],this.compressedGeometry=new we,this.centroid=new we,this.aggregateGeometries=[]}},we=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};const _r=["ELEMENTUID","TYPENAME"],$r={upperLeft:0,lowerLeft:1},Nr={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function vr(t){const e=new hr;e.version=t.version;const r=t.get_query_result();if(r.results_type.value!==0)throw new Error("Got a non-feature collection type");const s=r.get_feature_result(),i=e.queryResult.featureResult;i.objectIdFieldName=s.objectid_field_name,i.exceededTransferLimit=s.exceeded_transfer_limit,i.hasM=s.has_m,i.hasZ=s.has_z,i.geometryType=Y(Ie,s.geometry_type.value),i.globalIdFieldName=s.globalid_field_name,i.geohashFieldName=s.geohash_field_name;const n=i.uniqueIdField,l=s.unique_id_field;n.name=l.name,n.isSystemMaintained=l.isSystemMaintained;const d=i.geometryProperties,c=s.geometry_properties;d.shapeAreaFieldName=c.shapeAreaFieldName,d.shapeLengthFieldName=c.shapeLengthFieldName,d.units=c.units;const m=i.spatialReference,a=s.spatial_reference;m.wkid=a.wkid,m.latestWkid=a.latestWkid,m.vcsWkid=a.vcsWkid,m.latestVcsWkid=a.latestVcsWkid,m.wkt=a.wkt,i.transform=Lr(s.transform);const o=i.fields,p=i.fieldNameToAttributeIndexMap,u=s.fields,b=u.size();for(let _=0;_<b;_++){const $=u.get(_),L=lt($);o.push(L),p[L.name]=_,$.delete()}u.delete();const T=i.values,g=s.values_count();for(let _=0;_<g;_++)T.push(s.get_value_at(_));const v=i.features,E=s.features,M=E.size();if(M>0){for(const _ of _r)if(p[_]===void 0)throw new Error(`Feature collection missing required attribute: ${_}`)}for(let _=0;_<M;_++){const $=new Er,L=E.get(_),j=$.attributes,G=L.attributes_count();for(let F=0;F<G;F++)j.push(L.get_attribute_at(F));const U=L.get_compressed_geometry();U&&($.compressedGeometry=me(U),$.centroid=me(L.get_centroid()));const D=$.aggregateGeometries,C=L.aggregate_geometries,x=C.size();for(let F=0;F<x;F++){const k=C.get(F),X=me(k);D.push(X),k.delete()}C.delete(),v.push($),L.delete()}E.delete();const N=i.geometryFields,S=s.geometry_fields,w=S.size();for(let _=0;_<w;_++){const $=S.get(_),L=Sr($);N.push(L),$.delete()}return S.delete(),e}function me(t){const e=new we;e.geometryType=Y(Ie,t.geometry_type.value);const r=[],s=[];for(let i=0;i<t.lengths.length;i++)r.push(t.lengths[i]);for(let i=0;i<t.coords.length;i++)s.push(t.coords[i]);return e.lengths=r,e.coords=s,e}function lt(t){const e=new Ir;return e.name=t.name,e.alias=t.alias,e.fieldType=Y(or,t.field_type.value),e.sqlType=Y(Nr,t.sql_type.value),e.domain=t.domain,e.defaultValue=t.default_value,e}function Sr(t){const e=lt(t);return e.geometryType=Y(Ie,t.geometry_type.value),e}function Lr(t){const e=new ot;e.quantizeOriginPosition=Y($r,t.quantizeOriginPosition.value);const r=e.scale,s=t.scale;r.xScale=s.xScale,r.yScale=s.yScale,r.mScale=s.mScale,r.zScale=s.zScale;const i=e.translate,n=t.translate;return i.xTranslate=n.xTranslate,i.yTranslate=n.yTranslate,i.mTranslate=n.mTranslate,i.zTranslate=n.zTranslate,e}async function Mr(t){const e=[],r={generateAllSublayers:!1,namedTypeDefinitions:new Map};return t.entitiesUrl&&e.push(Fe(t.entitiesUrl).then(s=>{Re(s,r)})),t.relationshipsUrl&&e.push(Fe(t.relationshipsUrl).then(s=>{Re(s,r)})),await Promise.all(e),r}async function Ss(t,e){e??=!1;const r={generateAllSublayers:e,namedTypeDefinitions:new Map};return await Cr(t).then(s=>{Fr(s,r)}),r}async function Ls(t){const e=await Ee(),r=new e.MapOfObjectIdentifierSets;kr(r,e,t);const s=new e.MapOfObjectIdentifierSetsEncoder;try{s.set_map_of_identifier_sets(r),s.encode();const i=s.get_encoding_result();if(i.error.error_code!==0)throw new z("knowledge-graph:layer-support-utils",i.error.error_message);const n=structuredClone(i.get_byte_buffer());return s.delete(),n}finally{r.delete()}}function kr(t,e,r){for(const[s,i]of r.namedTypeDefinitions){if(!i.members||i.useAllData)continue;const n=i.members.keys();let l=!1,d=!0;const c=new e.ObjectIdArray,m=new e.StringArray,a=new e.GlobalIdArray,o=new e.IdentifierArray,p=new e.ObjectIdentifierSet;for(const u of n)d&&(l=!isNaN(Number(u)),d=!1),l?c.add_objectid(Number(u)):(m.add_string(u),a.add_globalid(u)),o.add_identifier(u);p.set_oid_array(c),p.set_string_array(m),p.set_globalid_array(a),p.set_identifier_array(o),c.delete(),m.delete(),a.delete(),o.delete(),t.put_identifier_set(s,p),p.delete()}return t}async function Fe(t){const e=await et(t,{responseType:"array-buffer"});return Dr(await e.data)}async function Dr(t){const e=new(await Ee()).FeatureCollectionDecoder,r=e.decode(new Uint8Array(t));if(r.error_code!==0)throw new z("knowledge-graph:layer-support-utils",r.error_message);const s=e.get_feature_collection(),i=vr(s);return e.delete(),i}async function Cr(t){const e=await et(t,{responseType:"array-buffer"}),r=await e.data;return xr(new Uint8Array(r))}async function xr(t){const e=new(await Ee()).MapOfObjectIdentifierSetsDecoder,r=e.decode(new Uint8Array(t)),s=new Map;if(r.error_code!==0)throw new z("knowledge-graph:layer-support-utils",r.error_message);const i=e.get_map_of_identifier_sets(),n=i.keys,l=n.size();for(let d=0;d<l;d++){const c=n.get(d),m=i.query_identifier_set(c),a=[];if(m.id_array_type.value===1){const o=m.get_globalid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_globalid_at(u))}else if(m.id_array_type.value===3){const o=m.get_identifier_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_identifier_at(u).toString())}else if(m.id_array_type.value===2){const o=m.get_string_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_string_at(u))}else{if(m.id_array_type.value!==0)throw new z("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const o=m.get_oid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_objectid_at(u).toString())}}s.set(c,a)}return e.delete(),s}function Re(t,e){if(!t?.queryResult?.featureResult)return e;const r=t.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const s of t.queryResult.featureResult.features){const i=s.attributes[r.TYPENAME],n=P(e.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map})),l=s.attributes[r.ELEMENTUID];if(s.compressedGeometry?.coords?.length>0){let d=s.compressedGeometry.lengths;s.compressedGeometry.geometryType==="esriGeometryPoint"&&(d=[]),n.members.set(l,{id:l,linkChartLocation:new dt(d,s.compressedGeometry.coords)})}else n.members.set(l,{id:l})}return e}function Fr(t,e){for(const[r,s]of t){const i=P(e.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map}));for(const n of s)i.members.has(n)||i.members.set(n,{id:n})}return e}const Ms={fetchAndConvertSerializedLinkChart:t=>Mr(t)},Te=(t,e)=>{if(t.type==="column-reference")return t.column===e.systemOidFieldName?"ID(n)":`n.${t.column}`;if(t.type==="string")return`'${t.value}'`;if(t.type==="number")return`${t.value}`;if(t.type==="binary-expression"&&e.supportedSqlTypes.has(t.left.type)&&e.supportedSqlTypes.has(t.right.type)&&e.supportedSqlOperators.has(t.operator))return`${Te(t.left,e)} ${t.operator} ${Te(t.right,e)}`;if(t.type==="binary-expression"&&t.operator==="LIKE"){let r="";if(t.left.type==="function"&&t.left.args.value[0].type==="column-reference")r+=`lower(n.${t.left.args.value[0].column})`;else{if(t.left.type!=="column-reference")return e.unsupportedOperationFound=!0,"";r+=`lower(n.${t.left.column})`}if(r+=" CONTAINS (",t.right.type!=="string")return e.unsupportedOperationFound=!0,"";{let s=t.right.value;s.startsWith("%")&&(s=s.slice(1)),s.endsWith("%")&&(s=s.slice(0,-1)),r+=`'${s.toLowerCase()}')`}return r}return e.unsupportedOperationFound=!0,""};let fe=class V{constructor(){this._featureLookup=new Map}static getInstance(){return V.instance||(V.instance=new V),V.instance}static resetInstance(){V.instance&&(V.instance=null)}deleteFromStore(e){e.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(e){const r=[];return e.forEach(s=>{const i=this.readFromStoreById(s);i&&r.push(i)}),r}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,r,s){const i=[];return e.forEach(n=>{if(!n?.id)return;n.properties||(n.properties=[]);let l,d=null;if(s&&n.properties[s]&&(d=ut(n.properties[s])),"originId"in n&&"destinationId"in n&&(n.properties[ue]=n.originId,n.properties[ce]=n.destinationId),n.properties[r]=n.id,n.id&&this._featureLookup.has(n.id)&&this._featureLookup.get(n.id).attributes){const c=this._featureLookup.get(n.id),m=JSON.parse(JSON.stringify(Object.assign(c.attributes,n.properties)));s&&n.properties[s]&&(m[s]=ct(n.properties[s])),l=new Ne(d?JSON.parse(JSON.stringify(d)):c?.geometry?JSON.parse(JSON.stringify(c.geometry)):null,m,null,n.properties[r])}else l=new Ne(d?JSON.parse(JSON.stringify(d)):null,n.properties,null,n.properties[r]);this._featureLookup.set(`${n.typeName?`${n.typeName}__${n.id}`:n.id}`,l),i.push(l)}),i}},ge,I=null;function ks(){return ge||(ge=yt(()=>import("./lclayout-6cdRR6IH.js"),__vite__mapDeps([0,1])).then(t=>t.l).then(({default:t})=>t({locateFile:e=>ht(`esri/libs/linkchartlayout/${e}`)})).then(t=>{Rr(t)}),ge)}function Rr(t){I=t}const Ae={right:0,left:1,top:2,bottom:3},Oe={none:0,"start-only":1,"start-and-end":2};function Ar(t){const e={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...t?.toJSON(),eventsTicksVisualization:t?.eventsTicksVisualization??"start-and-end"};return{...e,timeDirection:{value:Ae[e.timeDirection]??Ae.right},eventsTicksVisualization:{value:Oe[e.eventsTicksVisualization]??Oe["start-and-end"]}}}function Q(t,e,r,s,i,n){const l=r.length,d=i.length,c=Float64Array.BYTES_PER_ELEMENT,m=Uint32Array.BYTES_PER_ELEMENT,a=Uint8Array.BYTES_PER_ELEMENT,o=16,p=o+l*(a+2*c)+d*(2*m),u=I._malloc(p);try{const b=u+o-u%o,T=b+l*c,g=T+l*c,v=g+d*m,E=v+d*m,M=()=>[I.HEAPF64.subarray(b>>3,(b>>3)+l),I.HEAPF64.subarray(T>>3,(T>>3)+l),I.HEAPU32.subarray(g>>2,(g>>2)+d),I.HEAPU32.subarray(v>>2,(v>>2)+d),I.HEAPU8.subarray(E,E+l)],[N,S,w,_,$]=M();N.set(r),S.set(s),w.set(i),_.set(n),$.set(e);const L=t(l,E,b,T,d,g,v);let j=null,G=null;if(L.value===0){const k=I.getLayoutLinksTypes(),X=I.getLayoutLinksVerticesEndIndices(),he=I.getLayoutLinksVertices(),$e=I.countLayoutLinksVertices();!d||k&&X?$e&&!he?L.value=1:(j={types:new Uint8Array(I.HEAPU8.subarray(k,k+d)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(X>>2,(X>>2)+d)),vertices:new Float64Array(I.HEAPF64.subarray(he>>3,(he>>3)+2*$e))},G=I.getAuxiliaryGraphicElements()):L.value=1}const[U,D,C,x,F]=M();return r.set(U),s.set(D),i.set(C),n.set(x),e.set(F),{status:L.value,links:j,graphics:G}}finally{I._free(u),I.cleanupLayout()}}const je=2,qe=1,Pe=-1;var Ge,Ue,He,ze,Be,Qe,We;(function(t){function e(){return I.getMinIdealEdgeLength()}function r(s,i,n,l,d,c,m=je,a=qe,o=Pe){return Q((p,u,b,T,g,v,E)=>I.applyForceDirectedLayout(s,p,u,b,T,g,v,E,m,a,o),i,n,l,d,c)}t.getMinIdealEdgeLength=e,t.apply=r})(Ge||(Ge={})),(function(t){function e(r,s,i,n,l,d,c=je,m=qe,a=Pe){return Q((o,p,u,b,T,g,v)=>I.applyCommunityLayout(r,o,p,u,b,T,g,v,c,m,a),s,i,n,l,d)}t.apply=e})(Ue||(Ue={})),(function(t){function e(r,s,i,n,l,d){return Q((c,m,a,o,p,u,b)=>I.applySimpleLayout(r,c,m,a,o,p,u,b),s,i,n,l,d)}t.apply=e})(He||(He={})),(function(t){function e(r,s,i,n,l,d){return Q((c,m,a,o,p,u,b)=>I.applyHierarchicalLayout(r,c,m,a,o,p,u,b),s,i,n,l,d)}t.apply=e})(ze||(ze={})),(function(t){function e(r,s,i,n,l,d){return Q((c,m,a,o,p,u,b)=>I.applyRadialTreeLayout(r,c,m,a,o,p,u,b),s,i,n,l,d)}t.apply=e})(Be||(Be={})),(function(t){function e(r,s,i,n,l,d){return Q((c,m,a,o,p,u,b)=>I.applySmartTreeLayout(r,c,m,a,o,p,u,b),s,i,n,l,d)}t.apply=e})(Qe||(Qe={})),(function(t){function e(r,s,i,n,l,d,c,m,a,o,p,u){return Q((b,T,g,v,E,M,N)=>{if(l.length!==b)return{value:1};if(d.length!==b)return{value:1};if(a.length!==E)return{value:1};if(o.length!==E)return{value:1};const S=Float64Array.BYTES_PER_ELEMENT,w=16,_=I._malloc(w+b*S),$=I._malloc(w+b*S),L=I._malloc(w+E*S),j=I._malloc(w+E*S),G=_+w-_%w,U=$+w-$%w,D=L+w-L%w,C=j+w-j%w;try{return I.HEAPF64.subarray(G>>3,(G>>3)+b).set(l),I.HEAPF64.subarray(U>>3,(U>>3)+b).set(d),I.HEAPF64.subarray(D>>3,(D>>3)+E).set(a),I.HEAPF64.subarray(C>>3,(C>>3)+E).set(o),I.applyChronologicalLayout(r,b,T,g,v,G,U,E,M,N,D,C,p,Ar(u))}finally{I._free(_),I._free($),I._free(L),I._free(j)}},s,i,n,c,m)}t.apply=e})(We||(We={}));tt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});tt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Or=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function jr(t,e){const r=new Map;if(e.dataModel?.relationshipTypes)for(const s of e.dataModel.relationshipTypes)s.name&&r.set(s.name,[]);for(const s of t)r.has(s.typeName)&&r.get(s.typeName)?.push(s.id);return r}async function Ds(t,e,r){const s=[],i=jr(t,e),n={},l=[];for(const[a,o]of i){if(o.length<1)continue;const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n)-[r:${a}]->(m) WHERE id(r) in $${p} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(l.length===0)return[];const d=l.join(" UNION "),c=new W({openCypherQuery:d,bindParameters:n}),m=(await Z(e,c,r?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(const p of o)s.push({id:p[0],typeName:p[1]}),s.push({id:p[2],typeName:p[3]})}return s}const Cs=t=>Or.get(t)??"radial-root-centric";function qr(t){if(!t.spatialReference.isWGS84)throw new z("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return t.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}let q=class extends rt{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const r=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(s=>{s.name&&(r.set(s.name,"entity"),this._processingCacheUpdatesLookup.set(s.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(s.name),s.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(s.name,{name:i.name??"",geometryType:i.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(s=>{s.name&&(r.set(s.name,"relationship"),this._processingCacheUpdatesLookup.set(s.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(s.name),s.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(s.name,{name:i.name??"",geometryType:i.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((s,i)=>{if(r.get(i)==="entity")this.entityTypeNames.add(i);else{if(r.get(i)!=="relationship")return st.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const n=new Map;s.members?.forEach(l=>{P(this.memberIdTypeLookup,l.id,()=>new Set).add(i)}),this.sublayerCaches.set(i,n)})}addToLayer(e){e.forEach(({typeName:r,id:s})=>{if(!this.inclusionModeDefinition)throw new z("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(r);i.members||(i.members=new Map),i.members.set(s,{id:s}),P(this.memberIdTypeLookup,s,()=>new Set).add(r)}}else{const i=new Map;i.set(s,{id:s}),this.inclusionModeDefinition.namedTypeDefinitions.set(r,{useAllData:!1,members:i}),P(this.memberIdTypeLookup,s,()=>new Set).add(r)}})}getById(e){return fe.getInstance().readFromStoreById(e)}async getData(e,r,s){if(r.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(r.objectType.name))return[];let i;if(i=e||new J({where:"1=1",outFields:["*"]}),r.parentCompositeLayer.type==="link-chart"){const n=r.parentCompositeLayer,l=this._processingCacheUpdatesLookup.get(r.objectType.name??""),d=i.outFields;d&&d.length===1&&d[0]===R&&i.where==="1=1"||await Promise.all(l??[]);const c=this.sublayerCaches.has(r.objectType.name??"")?Array.from(this.sublayerCaches.get(r.objectType.name)?.values()):[],m=[];return c.forEach(a=>{if(this.relationshipTypeNames.has(r.objectType.name)){a.geometry=n.relationshipLinkChartDiagramLookup.get(a.attributes[r.objectIdField]);const o=this.memberIdTypeLookup.get(a.attributes[ue]),p=this.memberIdTypeLookup.get(a.attributes[ce]),u=this._isEndEntitySpatial(o,a,ue),b=this._isEndEntitySpatial(p,a,ce);a.attributes[ae]=Number(u&&b)}else{a.geometry=n.entityLinkChartDiagramLookup.get(a.attributes[r.objectIdField]);const o=this.geographicLookup.get(r.objectType.name);o&&a.attributes[o.name]?a.attributes[ae]=1:a.attributes[ae]=0}a.attributes[_e]=a.geometry,m.push(a)}),m}return this.retrieveDataFromService(i,r,s)}async getConnectedRecordIds(e,r,s){const i=[];let n="";const l=this._getNamedTypeIdMapFromNodeIds(e);if(r&&r?.length!==0){for(const o of r)n=n+o+"|";n=n.slice(0,-1)}const d={},c=[];for(const[o,p]of l){const u=`${o}_ids`;d[u]=p,r&&r?.length!==0?c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${n}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!c.length)return i;const m=c.join(" UNION "),a=(await Z(this.knowledgeGraph,new W({openCypherQuery:m,bindParameters:d}),{signal:s?.signal})).resultRowsStream.getReader();for(;;){const{done:o,value:p}=await a.read();if(o)break;for(let u=0;u<p.length;u++){const b=p[u];i.push({id:b[0],typeName:b[1]}),i.push({id:b[2],typeName:b[3]})}}return i}async getRelationshipsBetweenNodes(e,r,s){const i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0)return[];const n={relationshipExclusionIds:r,possibleConnectionEntityIds:e},l=[];for(const[a,o]of i.entries()){const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n:${a}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const d=l.join(" UNION "),c=[],m=(await Z(this.knowledgeGraph,new W({openCypherQuery:d,bindParameters:n}),{signal:s?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(let p=0;p<o.length;p++){const u=o[p];c.push({id:u[0],typeName:u[1]})}}return c}async getRelationshipsFromNodes(e,r,s,i){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0||r.length===0)return[];const l={relationshipExclusionIds:s,possibleConnectionEntityIds:r},d=[];for(const[p,u]of n.entries()){const b=`${p}_ids`;l[b]=u,d.push(`MATCH (n:${p}) WHERE id(n) IN $${b} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const c=d.join(" UNION "),m=new Map,a=(await Z(this.knowledgeGraph,new W({openCypherQuery:c,bindParameters:l}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:u}=await a.read();if(p)break;for(let b=0;b<u.length;b++){const T=u[b];let g=m.get(T[1]);g||(g=new Set,m.set(T[1],g)),g.add(T[0])}}const o=[];for(const[p,u]of m)for(const b of u)o.push({id:b,typeName:p});return o}async refreshCacheContent(e,r,s,i=!0,n){const l=fe.getInstance(),d=[],c=new Map,m=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),e||this.inclusionModeDefinition?e?e.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const o of this.memberIdTypeLookup.get(a))c.has(o)?c.get(o)?.push(a):c.set(o,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,o)=>{a.useAllData?c.set(o,null):a.members&&a.members.forEach(p=>{c.has(o)&&c.get(o)!==null?c.get(o)?.push(p.id):c.set(o,[p.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}));for(const[a,o]of c){const p=new Set(o),u=new Promise((b,T)=>{(async()=>{const v=new Set,E=[];let M,N="",S=!1;if(r||m.get(a)?.properties?.forEach($=>{$.name&&v.add($.name)}),s&&this.geographicLookup.has(a)){const $=this.geographicLookup.get(a)?.name;$&&v.add($)}if(this.entityTypeNames.has(a))N=`MATCH (n:${a}) ${o?"WHERE id(n) IN $ids ":""}return ID(n)`,v.forEach($=>{N+=`, n.${$}`,E.push($)});else{if(!this.relationshipTypeNames.has(a))throw new z("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);S=!0,N=`MATCH ()-[n:${a}]->() ${o?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,v.forEach($=>{N+=`, n.${$}`,E.push($)})}M=new W(o?{openCypherQuery:N,bindParameters:{ids:o}}:{openCypherQuery:N});const w=(await Z(this.knowledgeGraph,M,{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:$,value:L}=await w.read();if($)break;const j=[];for(let D=0;D<L.length;D++){const C=L[D];let x=0,F=0;const k={properties:{}};for(k.id=C[x],x++,F++,S&&(k.originId=C[x],x++,F++,k.destinationId=C[x],x++,F++,P(this.nodeConnectionsLookup,k.originId,()=>new Set).add(k.id),P(this.nodeConnectionsLookup,k.destinationId,()=>new Set).add(k.id),P(this.relationshipConnectionsLookup,k.id,()=>[k.originId,k.destinationId]));x<C.length;x++)k.properties[E[x-F]]=C[x];p.delete(k.id),j.push(k)}const G=l.writeToStore(j,R,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const U=this.sublayerCaches.get(a);G.forEach(D=>{U?.set(D.attributes[R],D),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(D.attributes[R])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(D.attributes[R],{id:D.attributes[R]}),P(this.memberIdTypeLookup,D.attributes[R],()=>new Set).add(a))})}const _=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(_)for(const $ of p)_.members?.delete($)})().then(()=>{b(null)}).catch(v=>{v.name==="AbortError"?b(null):T(v)})});d.push(u),this._processingCacheUpdatesLookup.get(a)?.push(u)}if(await Promise.all(d),n?.signal?.aborted)throw mt()}removeFromLayer(e){const r=new Set,s=new Set(e.map(i=>i.id));for(const i of e)r.add(i.typeName),this.memberIdTypeLookup.get(i.id)?.size===1?this.memberIdTypeLookup.delete(i.id):this.memberIdTypeLookup.get(i.id)?.delete(i.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,l)=>{l===i.typeName&&n.members?.has(i.id)&&n.members.delete(i.id)});r.forEach(i=>{this.sublayerCaches.get(i)?.forEach((n,l)=>{s.has(l)&&this.sublayerCaches.get(i)?.delete(l)})})}async retrieveDataFromService(e,r,s){const i=fe.getInstance(),n=new Set,l=[];let d,c="",m=[];const a=r.graphType==="relationship",o=this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData,p=r.parentCompositeLayer.sublayerIdsCache.get(r.objectType.name);let u=!o&&p?Array.from(p).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData&&e.objectIds!=null&&(u=e.objectIds);else if(e.objectIds!=null&&u&&u.length>0){const T=e.objectIds;e.objectIds=u.filter(g=>T.includes(g))}else if(e.objectIds!=null)u=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(r.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=u}if(e.outFields!=null){const T=e.outFields;T.includes("*")?r.fields.forEach(g=>{n.add(g.name)}):T.forEach(g=>{g!==R&&g!==r.geometryFieldName&&n.add(g)})}if(e.geometry!=null){const T=e.geometry;let g;const v=r.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,E=v?.spatialReference,M=v?.serviceCapabilities?.geometryCapabilities;let N=M?.geometryMaxBoundingRectangleSizeX,S=M?.geometryMaxBoundingRectangleSizeY;if(T.type==="point"){let w=T;w.spatialReference?.isWGS84||(await pe(w.spatialReference,B),w=se(w,B)),g=new de({spatialReference:B,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else T?.extent?.spatialReference&&!T.spatialReference?.isWGS84?(await pe(T.extent.spatialReference,B),g=se(T.extent,B)):g=T.extent;if(N&&S&&E){if(E.wkid!==4326){const w=new de({spatialReference:E,xmax:N,ymax:S}),_=se(w,B);N=_.xmax,S=_.ymax}if(g.xmax-g.xmin>N)throw new z("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${N}° latitude, limit exceeded`);if(g.ymax-g.ymin>S)throw new z("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${S}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const w=await ve(e.where.toUpperCase(),r.fieldsIndex);r.fields.forEach(_=>{w.fieldNames.includes(_.name)&&n.add(_.name)})}c=a?`Match ()-[n:${r.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${r.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n)`,r.geometryFieldName&&n.add(r.geometryFieldName),n.forEach(w=>{c+=`, n.${w}`,l.push(w)}),d=new W({openCypherQuery:c,bindParameters:{param_filter_geom:new it({rings:qr(g)})}})}else{let T="";if(e.where!=null&&e.where!=="1=1"){const E=await ve(e.where,r.fieldsIndex);r.fields.forEach(N=>{E.fieldNames.includes(N.name)&&n.add(N.name)});const M={systemOidFieldName:R,supportedSqlTypes:new Set(["column-reference","string","number","binary-expression"]),supportedSqlOperators:new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),unsupportedOperationFound:!1};T=Te(E.parseTree,M),M.unsupportedOperationFound&&(T="")}let g="";g=a?`Match ()-[n:${r.objectType.name}]->()`:`Match (n:${r.objectType.name})`;let v=!1;u&&(v=!0,g+=" WHERE ID(n) IN $ids"),T&&(g+=v?" AND":" WHERE",g+=` ${T}`),g+=" return ID(n)",a&&(g+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&r.geometryFieldName&&n.add(r.geometryFieldName),n.forEach(E=>{g+=`, n.${E}`,l.push(E)}),d=new W(u?{openCypherQuery:g,bindParameters:{ids:u}}:{openCypherQuery:g})}const b=(await Z(r.parentCompositeLayer.dataManager.knowledgeGraph,d,s)).resultRowsStream.getReader();for(;;){const{done:T,value:g}=await b.read();if(T)break;const v=[];for(let E=0;E<g.length;E++){const M=g[E];let N=0,S=0;const w={properties:{}};for(w.id=M[N],N++,S++,a&&(w.originId=M[N],N++,S++,w.destinationId=M[N],N++,S++);N<M.length;N++)w.properties[l[N-S]]=M[N];v.push(w)}m=m.concat(i.writeToStore(v,R,r.parentCompositeLayer.dataManager.geographicLookup.get(r.objectType.name)?.name))}return m}_isEndEntitySpatial(e,r,s){for(const i of e??[])if(this.entityTypeNames.has(i)){const n=this.geographicLookup.get(i),l=n&&this.sublayerCaches.get(i)?.get(r.attributes[s]);if(n&&l?.attributes[n.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const r=new Map;return e.forEach(s=>{if(this.memberIdTypeLookup.has(s))for(const i of this.memberIdTypeLookup.get(s)){if(!this.entityTypeNames.has(i))return;r.has(i)?r.get(i)?.push(s):r.set(i,[s])}}),r}};y([h()],q.prototype,"knowledgeGraph",void 0),y([h()],q.prototype,"inclusionModeDefinition",void 0),y([h()],q.prototype,"entityTypeNames",void 0),y([h()],q.prototype,"relationshipTypeNames",void 0),y([h()],q.prototype,"geographicLookup",void 0),y([h()],q.prototype,"sublayerCaches",void 0),y([h()],q.prototype,"nodeConnectionsLookup",void 0),y([h()],q.prototype,"relationshipConnectionsLookup",void 0),y([h()],q.prototype,"memberIdTypeLookup",void 0),q=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],q);const Pr=Symbol("isKnowledgeGraphGraphicOriginSymbol");var Ve;class Gr extends nt{get[(Ve=Pr,ft)](){return this.sublayer}get[gt](){return this.sublayer}get[at](){return this.sublayer}constructor(e,r){super(),this[Ve]=!0,this.type="knowledge-graph",this.layer=e,this.sublayer=r}get id(){return this.layer.id}}const Ur=Symbol("isLinkChartGraphicOriginSymbol");var Je;class Hr extends nt{get[(Je=Ur,at)](){return this.layer}constructor(e,r){super(),this[Je]=!0,this.type="link-chart",this.layer=e,this.sublayer=r}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}}const Ze=bt(),zr=t=>{const e=t;let r=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return y([h(Ze.fields)],r.prototype,"fields",void 0),y([h(Ze.fieldsIndex)],r.prototype,"fieldsIndex",void 0),r=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],r),r},Br=wt;let H=class extends rt{constructor(t){super(t),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};y([h()],H.prototype,"entityAdds",void 0),y([h()],H.prototype,"entityUpdates",void 0),y([h()],H.prototype,"entityDeletes",void 0),y([h()],H.prototype,"relationshipAdds",void 0),y([h()],H.prototype,"relationshipUpdates",void 0),y([h()],H.prototype,"relationshipDeletes",void 0),y([h()],H.prototype,"options",void 0),H=y([ye("esri.rest.knowledgeGraph.GraphApplyEdits")],H);const Qr={initializeLayersFromClientData:async(t,e,r)=>{if(e||(e=[...t.layers,...t.tables].map(n=>n.graphTypeName)),e?.length===0)return;const s=new Map;for(const n of e)s.set(n,Ke(t,n));const i=await lr(t.dataManager.knowledgeGraph,Array.from(s.values()),{requestOptions:{signal:r?.signal}});for(const n of[...t.layers,...t.tables]){const l=n.objectType.name;if(l==null)continue;const d=i.get(Ke(t,l));if(d){const c=JSON.parse(d);c===null||typeof c!="object"||c.hasOwnProperty("showLabels")||(c.showLabels=!1),n.read(c,{origin:"service"})}}}},Ke=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function Fs(t,e,r){return Qr.initializeLayersFromClientData(t,e,r)}const Ye=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Wr="#8f8f82";function Vr(t){return t<0||t>=Ye.length?new Se(Wr):new Se(Ye[t])}function Jr(t){const e=t.toArray();return new It({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function Zr(t){let e="ESRI__ID",r=4;for(const s of t)if(s.name){if(s.name.toLowerCase()==="name"){e=s.name;break}s.name.toLowerCase().includes("name")?(e=s.name,r=2):s.fieldType==="esriFieldTypeString"&&r>3&&(e=s.name,r=3)}return e}function Kr(t,e,r){const s={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},i=new K({labelExpressionInfo:new ne({expression:r==="ESRI__ID"?`${e}`:`$feature.${r}`}),labelPlacement:"above-center",symbol:new ie(s)}),n=new K({labelExpressionInfo:new ne({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new ie({...s,yoffset:"12px"})});return t==="entity"?[i]:[n]}function Yr(t,e,r){const s={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},i=r==="ESRI__ID"?`${t}`:`$feature.${r}`;return e==="point"?[new K({labelExpressionInfo:new ne({expression:i}),labelPlacement:"above-center",symbol:new ie(s)})]:e==="polyline"?[new K({labelExpressionInfo:new ne({expression:i}),labelPlacement:"center-along",repeatLabel:!0,symbol:new ie(s)})]:e==="polygon"?[new K({labelExpressionInfo:new ne({expression:i}),labelPlacement:"always-horizontal",symbol:new ie(s)})]:null}const Xr={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function es(t){const{capabilities:e,allowGeometryUpdates:r,serviceCapabilities:{geometryCapabilities:{supportsZValues:s,supportsMValues:i}}}=t?.serviceDefinition||Xr,n=t?.dataModel.arcgisManaged?e:e.filter(d=>d==="Query"),l=new Set(n);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:i,supportsZ:s},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:l.has("Create"),supportsDelete:l.has("Delete"),supportsEditing:l.has("Editing"),supportsChangeTracking:!1,supportsQuery:l.has("Query"),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:l.has("Update"),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:yr,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:cr,editing:{supportsGeometryUpdate:!!t?.dataModel.arcgisManaged&&r,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:l.has("Delete"),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:l.has("Update"),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function ts(t,e){const r=new H,s=e.graphTypeName,i=e.graphType,n=e.parentCompositeLayer.type==="knowledge-graph"?e.geometryFieldName:null,l=!!e.fieldsIndex.get(n)?.editable,d=a=>{const o={...a};for(const p of e.fields)p.editable||delete o[p.name];for(const p of Object.keys(a))p.includes("ESRI__")&&delete o[p];return o},c=async a=>{await pe(a.spatialReference,le.WGS84);const o=se(a,le.WGS84);return o.type==="point"?o.normalize():(await $t(o))[0]};for(const a of t.addFeatures??[]){const o=d(a.attributes);Le(a.sourceLayer)&&a.sourceLayer.graphTypeName===s&&(i==="entity"?(r.entityAdds||(r.entityAdds=[]),n&&a.geometry&&(o[n]=await c(a.geometry)),r.entityAdds.push(new De({properties:o,typeName:s}))):(r.relationshipAdds||(r.relationshipAdds=[]),r.relationshipAdds.push(new Ce({properties:o,typeName:s}))))}for(const a of t.updateFeatures??[]){const o=a.attributes[R],p=d(a.attributes);Le(a.sourceLayer)&&a.sourceLayer.graphTypeName===s&&(i==="entity"?(r.entityUpdates||(r.entityUpdates=[]),n&&l&&a.geometry&&(p[n]=await c(a.geometry)),r.entityUpdates.push(new De({id:o,properties:p,typeName:s}))):(r.relationshipUpdates||(r.relationshipUpdates=[]),r.relationshipUpdates.push(new Ce({id:o,properties:p,typeName:s}))))}const m=new Map;for(const a of t.deleteFeatures??[])if(_t(a)){const o=a,p=P(m,o.sourceLayer.graphTypeName,()=>({typeName:o.sourceLayer.graphTypeName,ids:[]}));o.sourceLayer.graphTypeName===s&&p.ids.push(o.attributes[R])}else a.objectId&&typeof a.objectId=="string"&&P(m,s,()=>({typeName:s,ids:[]})).ids.push(a.objectId);for(const a of m.values())a.ids.length>0&&(i==="entity"?(r.entityDeletes||(r.entityDeletes=[]),r.entityDeletes.push({typeName:a.typeName,ids:a.ids})):(r.relationshipDeletes||(r.relationshipDeletes=[]),r.relationshipDeletes.push({typeName:a.typeName,ids:a.ids})));return r}function rs(t,e){const r={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(const s of t.editResults)if(s.typeName===e){for(const i of s.adds)r.addFeatureResults.push({objectId:i.id,globalId:i.id});for(const i of s.updates)r.updateFeatureResults.push({objectId:i.id,globalId:i.id});for(const i of s.deletes)r.deleteFeatureResults.push({objectId:i.id,globalId:i.id})}return r}function ss(t){if(!t.objectType)return null;const e=[];for(const r of t.fields)!r.name.includes("ESRI__")&&r.editable&&r.type!=="geometry"&&e.push(new Br({fieldName:r.name}));return new Tt({elements:e})}function is(t){if(!t.objectType)return null;let e=null;switch(t.geometryType){case"point":case"multipoint":e="point";break;case"polyline":e="line";break;case"polygon":e="polygon";break;default:e=null}return[new Et({name:t.graphTypeName,drawingTool:e,prototype:{}})]}function O(t){if(!t.json)return t;t.json.write=Xe(t.json.write);const e=t.json.origins;if(!e)return t;let r;for(r in e){const s=e[r];s&&(s.write=Xe(s.write))}return t}function Xe(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=ns(t)),t):t===!0?te():t}function ns(t){const{target:e,writer:r,overridePolicy:s,...i}=t;return function(n,l){const d=pt.call(this,n,l);return d.enabled?{...i,...d}:d}}function te(){return{overridePolicy:pt}}function pt(t,e){const r=!!this.geometryType;let s={enabled:r};return r&&(s={...s,...re.call(this,t,e)}),s}function re(t,e){return{ignoreOrigin:this.originIdOf(e)>0}}let f=class extends zr(Nt(vt(St(Lt(Mt(kt(Dt(Ct(xt(Ut)))))))))){constructor(t){super(t),this.blendMode="normal",this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=R,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new Ft(e.port1,{channel:e,client:{queryFeatures:(r,s={})=>{const i=J.fromJSON(r);return this.queryFeaturesJSON(i,s)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:es(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.capabilities.operations.supportsEditing}set editingEnabled(t){this._overrideIfSome("editingEnabled",t)}get isTable(){return this.parentCompositeLayer.type!=="link-chart"&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){const t=[];return this.objectType?.properties?.forEach(e=>{const r=e.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":e.fieldType;t.push(oe.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:e.defaultValue,editable:e.editable,nullable:e.nullable}))}),t.push(oe.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),oe.fromJSON({name:be,type:"esriFieldTypeInteger",alias:be,editable:!1}),oe.fromJSON({name:ae,type:"esriFieldTypeInteger",alias:ae,editable:!1})),t}get formTemplate(){return this._isOverridden("formTemplate")?this._get("formTemplate"):ss(this)}set formTemplate(t){this._overrideIfSome("formTemplate",t)}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.geometryType;return e&&e!=="esriGeometryNull"?ee.fromJSON(e):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?_e:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case"knowledge-graph":return new Gr(this.parent,this);case"link-chart":return new Hr(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(t){this._set("graphTypeName",t)}get hasM(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasM??!1}get hasZ(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasZ??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const t=this.objectType.properties?Zr(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Kr(this.graphType,this.graphTypeName,t):Yr(this.graphTypeName,this.geometryType,t)}set renderer(t){Rt(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const t=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,e=[...t?.entityTypes??[],...t?.relationshipTypes??[]].map(i=>i.name).indexOf(this.graphTypeName),r=Vr(e);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new At({type:"simple",symbol:Jr(r)});const i=Me(xe(ee.toJSON("point")).renderer);return ke(i.symbol,r),i}const s=Me(xe(ee.toJSON(this.geometryType)).renderer);return ke(s.symbol,r),s}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??le.WGS84}get templates(){return this._isOverridden("templates")?this._get("templates"):is(this)}set templates(t){this._overrideIfSome("templates",t)}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return Ot(this,t)}createQuery(){return new J({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:r,queryEngine:s}=await this._setupQueryObjects(t),i=this.graphicOrigin,n=jt.fromJSON(await s.executeQuery(r.toJSON(),e?.signal));return n.features.forEach(l=>{l.sourceLayer=this,l.origin=i}),n}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:r,queryEngine:s}=await this._setupQueryObjects(t);return await s.executeQuery(r.toJSON(),e?.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:r,queryEngine:s}=await this._setupQueryObjects(t);return s.executeQueryForCount(r.toJSON(),e?.signal)}async queryExtent(t={},e){await this.load();const r={...t,returnGeometry:!0},{resolvedQuery:s,queryEngine:i}=await this._setupQueryObjects(r),n=await i.executeQueryForExtent(s.toJSON(),e?.signal);let l;return l=n.extent?.xmin!=null&&n.extent?.xmax!=null&&n.extent?.ymin!=null&&n.extent?.ymax!=null?new de(n.extent):new de,{count:n.count,extent:l}}async queryObjectIds(t,e){await this.load();const r=J.from(t);let s;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)s=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(r,this,e);s=this.loadQueryEngine(i)}return await s.executeQueryForIds(r.toJSON(),e?.signal)}async applyEdits(t){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new z("knowledge-graph-sublayer:no-knowledge-graph","ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded");const e=await ts(t,this);e.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};const r=await pr(this.parentCompositeLayer.dataManager.knowledgeGraph,e),s=rs(r,this.graphTypeName),i={addedFeatures:s.addFeatureResults,updatedFeatures:s.updateFeatureResults,deletedFeatures:s.deleteFeatureResults,addedAttachments:s.addAttachmentResults,deletedAttachments:s.deleteAttachmentResults,updatedAttachments:s.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit("edits",i),this.emit("apply-edits",{result:Promise.resolve(i)}),this.parentCompositeLayer.type==="link-chart"&&await this.parentCompositeLayer.refreshLinkChartCache([...i.addedFeatures.map(n=>n.globalId),...i.updatedFeatures.map(n=>n.globalId),...i.deletedFeatures.map(n=>n.globalId)]),s}loadQueryEngine(t){const e=new dr({geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new ur({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:e});return r.featureStore.addMany(t),r}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new J({where:"1=1",outFields:[R]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>qt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){const r=J.from(t),s=r.geometry;if(s&&!s.spatialReference?.isWGS84&&(await pe(s.spatialReference,B),r.geometry=se(s instanceof it||s instanceof Pt||s instanceof Gt?s:s.extent,B)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};const i=await this.parentCompositeLayer.dataManager.getData(r,this,e);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(i)}}};function as(t,e,r){const s=[["ESRI__AGGREGATION_COUNT",be],["ESRI__ORIGIN_ID",ue],["ESRI__DESTINATION_ID",ce],["ESRI__LAYOUT_GEOMETRY",_e]];try{for(const i of t)for(const[n,l]of s)i.labelExpression=i.labelExpression?.replaceAll(n,l),i.labelExpressionInfo?.expression&&(i.labelExpressionInfo.expression=i.labelExpressionInfo.expression.replaceAll(n,l))}catch(i){st.getLogger(this).warn("Error updating labelingInfo",i)}return ar(t,e,r)}y([h(O(A(Ht)))],f.prototype,"blendMode",void 0),y([h({readOnly:!0})],f.prototype,"capabilities",null),y([h({readOnly:!0})],f.prototype,"userHasUpdateItemPrivileges",null),y([h({type:Boolean})],f.prototype,"editingEnabled",null),y([h()],f.prototype,"isTable",null),y([h({json:{origins:{"web-scene":{write:!1}},write:te()}})],f.prototype,"charts",void 0),y([h({readOnly:!0})],f.prototype,"defaultPopupTemplate",null),y([h({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],f.prototype,"definitionExpression",void 0),y([h(O(A(zt)))],f.prototype,"displayFilterEnabled",void 0),y([h(O(A(Bt)))],f.prototype,"displayFilterInfo",void 0),y([h(O(A(Qt)))],f.prototype,"effect",void 0),y([h()],f.prototype,"elevationInfo",void 0),y([h(O(A(Wt)))],f.prototype,"featureEffect",void 0),y([h(O(A(Vt)))],f.prototype,"featureReduction",null),y([h()],f.prototype,"fields",null),y([h()],f.prototype,"formTemplate",null),y([h()],f.prototype,"geometryType",null),y([h()],f.prototype,"geometryFieldName",null),y([h({readOnly:!0})],f.prototype,"graphicOrigin",null),y([h({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphType",void 0),y([h({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphTypeName",null),y([h()],f.prototype,"hasM",null),y([h()],f.prototype,"hasZ",null),y([h({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],f.prototype,"id",void 0),y([h({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],f.prototype,"labelsVisible",void 0),y([h({type:[K],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:as,write:te()}})],f.prototype,"labelingInfo",null),y([h({readOnly:!0,json:{read:!1,write:{writer(t,e){switch(this.parentCompositeLayer?.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"layerType",void 0),y([h(O(A(Jt)))],f.prototype,"legendEnabled",void 0),y([h(O(A(Zt)))],f.prototype,"maxScale",void 0),y([h(O(A(Kt)))],f.prototype,"minScale",void 0),y([h()],f.prototype,"objectIdField",void 0),y([h()],f.prototype,"objectType",void 0),y([h(O(A(Yt)))],f.prototype,"opacity",void 0),y([h(O(A(Xt)))],f.prototype,"orderBy",void 0),y([h({clonable:!1})],f.prototype,"parent",void 0),y([h()],f.prototype,"parentCompositeLayer",void 0),y([h(O(A(er)))],f.prototype,"popupEnabled",void 0),y([h({type:tr,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],f.prototype,"popupTemplate",void 0),y([h({type:Number,json:{write:{overridePolicy:re}}})],f.prototype,"refreshInterval",void 0),y([h({types:rr,json:{name:"layerDefinition.drawingInfo.renderer",write:te()}})],f.prototype,"renderer",null),y([h()],f.prototype,"source",void 0),y([h()],f.prototype,"spatialReference",null),y([h()],f.prototype,"templates",null),y([h({type:sr,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:re},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:re}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:re}}}}})],f.prototype,"timeInfo",null),y([h({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"title",null),y([ir("title")],f.prototype,"writeTitle",null),y([h({json:{read:!1}})],f.prototype,"type",void 0),y([h(O(A(nr)))],f.prototype,"useViewTime",void 0),y([h({type:Boolean,json:{name:"visibility",write:te()}})],f.prototype,"visible",void 0),f=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],f);export{He as A,Cs as C,es as F,Ms as I,Fs as L,f as N,ze as P,q as a,We as b,Be as c,Qe as d,Ue as e,Ss as f,Ds as g,fe as o,Ge as p,ks as r,Ls as w};
